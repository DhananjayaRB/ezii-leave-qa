<!DOCTYPE html>
<html>
<head>
    <title>Get JWT Token for Pro-rata Calculations</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 800px; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .info { background: #e3f2fd; padding: 15px; border-radius: 4px; margin: 20px 0; }
        .success { background: #e8f5e8; border: 1px solid #4caf50; }
        .error { background: #ffebee; border: 1px solid #f44336; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1976D2; }
        .token-display { background: #f5f5f5; padding: 15px; border-radius: 4px; font-family: monospace; word-break: break-all; }
    </style>
</head>
<body>
    <div class="container">
        <h1>JWT Token Setup for Pro-rata Calculations</h1>
        
        <div class="info">
            <strong>Why do we need this?</strong><br>
            The pro-rata leave balance calculations require employee joining dates from the external API. 
            Without accurate joining dates, we can't calculate how much leave employees should have based on when they joined during the year.
        </div>

        <h3>Method 1: Paste JWT Token URL</h3>
        <p>If you have a URL that contains a JWT token (like /id/your-token), paste it here:</p>
        <input type="text" id="tokenUrl" placeholder="Paste URL with JWT token here..." />
        <button onclick="extractTokenFromUrl()">Extract and Store Token</button>

        <h3>Method 2: Direct JWT Token</h3>
        <p>If you have the JWT token directly, paste it here:</p>
        <input type="text" id="directToken" placeholder="Paste JWT token here..." />
        <button onclick="storeDirectToken()">Store Token</button>

        <div id="result"></div>

        <h3>Current Status</h3>
        <p><strong>Current JWT Token:</strong></p>
        <div id="currentToken" class="token-display">Loading...</div>
        
        <button onclick="testApiWithToken()" style="margin-top: 20px;">Test External API</button>
        <button onclick="clearToken()" style="margin-top: 20px; background: #f44336;">Clear Token</button>
    </div>

    <script>
        function updateTokenDisplay() {
            const token = localStorage.getItem('jwt_token');
            const display = document.getElementById('currentToken');
            if (token) {
                display.textContent = token;
                display.className = 'token-display success';
            } else {
                display.textContent = 'No JWT token stored';
                display.className = 'token-display error';
            }
        }

        function extractTokenFromUrl() {
            const url = document.getElementById('tokenUrl').value;
            const result = document.getElementById('result');
            
            try {
                // Look for /id/ pattern in URL
                const match = url.match(/\/id\/([^\/\?#]+)/);
                if (match) {
                    const token = match[1];
                    localStorage.setItem('jwt_token', token);
                    result.innerHTML = '<div class="info success">‚úÖ JWT token extracted and stored successfully!</div>';
                    updateTokenDisplay();
                    
                    // Also try to decode and store user info
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        localStorage.setItem('user_id', payload.user_id || payload.sub);
                        localStorage.setItem('org_id', payload.org_id);
                        localStorage.setItem('role', payload.role_name || payload.role);
                        result.innerHTML += '<div class="info">User ID: ' + (payload.user_id || payload.sub) + '<br>Org ID: ' + payload.org_id + '<br>Role: ' + (payload.role_name || payload.role) + '</div>';
                    } catch (e) {
                        console.log('Could not decode token payload:', e);
                    }
                } else {
                    result.innerHTML = '<div class="info error">‚ùå No JWT token found in URL. Please check the URL format.</div>';
                }
            } catch (error) {
                result.innerHTML = '<div class="info error">‚ùå Error processing URL: ' + error.message + '</div>';
            }
        }

        function storeDirectToken() {
            const token = document.getElementById('directToken').value.trim();
            const result = document.getElementById('result');
            
            if (token) {
                localStorage.setItem('jwt_token', token);
                result.innerHTML = '<div class="info success">‚úÖ JWT token stored successfully!</div>';
                updateTokenDisplay();
                
                // Try to decode user info
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    localStorage.setItem('user_id', payload.user_id || payload.sub);
                    localStorage.setItem('org_id', payload.org_id);
                    localStorage.setItem('role', payload.role_name || payload.role);
                    result.innerHTML += '<div class="info">User ID: ' + (payload.user_id || payload.sub) + '<br>Org ID: ' + payload.org_id + '<br>Role: ' + (payload.role_name || payload.role) + '</div>';
                } catch (e) {
                    result.innerHTML += '<div class="info">Token stored but could not decode user info</div>';
                }
            } else {
                result.innerHTML = '<div class="info error">‚ùå Please enter a JWT token</div>';
            }
        }

        function clearToken() {
            localStorage.removeItem('jwt_token');
            document.getElementById('result').innerHTML = '<div class="info">JWT token cleared</div>';
            updateTokenDisplay();
        }

        async function testApiWithToken() {
            const token = localStorage.getItem('jwt_token');
            const result = document.getElementById('result');
            
            if (!token) {
                result.innerHTML = '<div class="info error">‚ùå No JWT token available. Please add one first.</div>';
                return;
            }

            result.innerHTML = '<div class="info">üîÑ Testing external API...</div>';

            try {
                const response = await fetch('https://qa-api.resolveindia.com/worker-master-leave', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const employeeCount = data.data?.data?.length || 0;
                    result.innerHTML = '<div class="info success">‚úÖ External API working! Found ' + employeeCount + ' employees with joining dates.</div>';
                    
                    // Show sample joining dates
                    if (data.data?.data?.length > 0) {
                        const sample = data.data.data.slice(0, 3).map(emp => 
                            `${emp.user_name || emp.user_id}: ${emp.date_of_joining}`
                        ).join('<br>');
                        result.innerHTML += '<div class="info">Sample joining dates:<br>' + sample + '</div>';
                    }
                } else {
                    result.innerHTML = '<div class="info error">‚ùå API Error: ' + response.status + ' - ' + (await response.text()) + '</div>';
                }
            } catch (error) {
                result.innerHTML = '<div class="info error">‚ùå Network Error: ' + error.message + '</div>';
            }
        }

        // Initialize display
        updateTokenDisplay();
    </script>
</body>
</html>